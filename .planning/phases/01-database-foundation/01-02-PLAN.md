---
phase: 01-database-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Model/Table/RolesTable.php
  - src/Model/Table/PermissionsTable.php
  - src/Model/Table/UsersRolesTable.php
  - src/Model/Table/UsersPermissionsTable.php
  - src/Model/Table/RolesPermissionsTable.php
  - src/Model/Entity/Role.php
  - src/Model/Entity/Permission.php
  - src/Model/Entity/UsersRole.php
  - src/Model/Entity/UsersPermission.php
  - src/Model/Entity/RolesPermission.php
autonomous: true

must_haves:
  truths:
    - "Roles can load associated permissions via contain()"
    - "Roles can load associated users via contain()"
    - "Permissions can load associated roles via contain()"
    - "Users can load roles and permissions through pivot tables"
    - "Pivot table classes enable explicit association configuration"
  artifacts:
    - path: "src/Model/Table/RolesTable.php"
      provides: "Role model with associations"
      exports: ["belongsToMany Users", "belongsToMany Permissions"]
      min_lines: 50
    - path: "src/Model/Table/PermissionsTable.php"
      provides: "Permission model with associations"
      exports: ["belongsToMany Roles", "belongsToMany Users"]
      min_lines: 40
    - path: "src/Model/Table/UsersRolesTable.php"
      provides: "Pivot table for user-role assignments"
      exports: ["belongsTo Users", "belongsTo Roles"]
    - path: "src/Model/Entity/Role.php"
      provides: "Role entity with accessible fields"
      contains: "_accessible"
    - path: "src/Model/Entity/Permission.php"
      provides: "Permission entity with accessible fields"
      contains: "_accessible"
  key_links:
    - from: "RolesTable"
      to: "PermissionsTable"
      via: "belongsToMany through RolesPermissions"
      pattern: "belongsToMany.*Permissions.*through.*RolesPermissions"
    - from: "RolesTable"
      to: "CakeDC/Users.Users"
      via: "belongsToMany through UsersRoles"
      pattern: "belongsToMany.*Users.*CakeDC"
---

<objective>
Create Table classes with ORM associations and Entity classes for all RBAC models.

Purpose: Provide the model layer that enables CakePHP ORM queries with eager loading, association containment, and proper validation.

Output: Five Table classes with configured associations and five Entity classes with accessible fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-database-foundation/01-CONTEXT.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create primary Table classes (Roles and Permissions)</name>
  <files>
    src/Model/Table/RolesTable.php
    src/Model/Table/PermissionsTable.php
  </files>
  <action>
Create `RolesTable` in `Rbac` plugin namespace with:
- `setTable('roles')`, `setDisplayField('name')`, `setPrimaryKey('id')`
- `addBehavior('Timestamp')`
- `belongsToMany('Users')` association:
  - className: 'CakeDC/Users.Users'
  - through: 'Rbac.UsersRoles'
  - foreignKey: 'role_id'
  - targetForeignKey: 'user_id'
  - saveStrategy: 'append'
- `belongsToMany('Permissions')` association:
  - className: 'Rbac.Permissions'
  - through: 'Rbac.RolesPermissions'
  - foreignKey: 'role_id'
  - targetForeignKey: 'permission_id'
  - saveStrategy: 'append'
- `belongsTo('ParentRoles')` for future hierarchy:
  - className: 'Rbac.Roles'
  - foreignKey: 'parent_id'
- `hasMany('ChildRoles')` for future hierarchy:
  - className: 'Rbac.Roles'
  - foreignKey: 'parent_id'
- `validationDefault()` with:
  - name: scalar, maxLength 255, required on create, not empty, unique rule
  - description: scalar, allow empty
  - is_system: boolean, not empty
  - is_default: boolean, not empty
  - is_active: boolean, not empty
  - sort_order: integer, not empty

Create `PermissionsTable` in `Rbac` plugin namespace with:
- `setTable('permissions')`, `setDisplayField('name')`, `setPrimaryKey('id')`
- `addBehavior('Timestamp')`
- `belongsToMany('Roles')` association:
  - className: 'Rbac.Roles'
  - through: 'Rbac.RolesPermissions'
  - foreignKey: 'permission_id'
  - targetForeignKey: 'role_id'
  - saveStrategy: 'append'
- `belongsToMany('Users')` association (direct permissions):
  - className: 'CakeDC/Users.Users'
  - through: 'Rbac.UsersPermissions'
  - foreignKey: 'permission_id'
  - targetForeignKey: 'user_id'
  - saveStrategy: 'append'
- `validationDefault()` with:
  - name: scalar, maxLength 255, required on create, not empty, unique rule, regex pattern `[a-zA-Z0-9.]+`
  - description: scalar, allow empty
  - is_active: boolean, not empty

Add PHPDoc blocks to all public methods.
  </action>
  <verify>
Classes exist with correct namespace `Rbac\Model\Table`. Associations use explicit `through` option for all belongsToMany. Validation rules include unique constraint on name fields.
  </verify>
  <done>
RolesTable has belongsToMany Users and Permissions with through tables.
PermissionsTable has belongsToMany Roles and Users with through tables.
Both have Timestamp behavior and validation rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pivot Table classes</name>
  <files>
    src/Model/Table/UsersRolesTable.php
    src/Model/Table/UsersPermissionsTable.php
    src/Model/Table/RolesPermissionsTable.php
  </files>
  <action>
Create `UsersRolesTable` in `Rbac` plugin namespace:
- `setTable('users_roles')`
- No primary key setter (composite primary key handled by database)
- `addBehavior('Timestamp')`
- `belongsTo('Users')`:
  - className: 'CakeDC/Users.Users'
  - foreignKey: 'user_id'
  - joinType: 'INNER'
- `belongsTo('Roles')`:
  - className: 'Rbac.Roles'
  - foreignKey: 'role_id'
  - joinType: 'INNER'

Create `UsersPermissionsTable` in `Rbac` plugin namespace:
- `setTable('users_permissions')`
- `addBehavior('Timestamp')`
- `belongsTo('Users')`:
  - className: 'CakeDC/Users.Users'
  - foreignKey: 'user_id'
  - joinType: 'INNER'
- `belongsTo('Permissions')`:
  - className: 'Rbac.Permissions'
  - foreignKey: 'permission_id'
  - joinType: 'INNER'

Create `RolesPermissionsTable` in `Rbac` plugin namespace:
- `setTable('roles_permissions')`
- `addBehavior('Timestamp')`
- `belongsTo('Roles')`:
  - className: 'Rbac.Roles'
  - foreignKey: 'role_id'
  - joinType: 'INNER'
- `belongsTo('Permissions')`:
  - className: 'Rbac.Permissions'
  - foreignKey: 'permission_id'
  - joinType: 'INNER'

Add PHPDoc blocks to all public methods.
  </action>
  <verify>
All three pivot Table classes exist with belongsTo associations to both related tables. Each has Timestamp behavior. Class names follow CakePHP conventions.
  </verify>
  <done>
Three pivot Table classes created with explicit belongsTo associations enabling ORM containment from pivot tables.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Entity classes</name>
  <files>
    src/Model/Entity/Role.php
    src/Model/Entity/Permission.php
    src/Model/Entity/UsersRole.php
    src/Model/Entity/UsersPermission.php
    src/Model/Entity/RolesPermission.php
  </files>
  <action>
Create `Role` entity in `Rbac\Model\Entity` namespace:
- Extend `Cake\ORM\Entity`
- Define `$_accessible` array with all fields accessible except `id`
- Fields: name, description, is_system, is_default, is_active, sort_order, parent_id, deleted_at, created, modified
- Mark association fields accessible: users, permissions, parent_role, child_roles, _joinData

Create `Permission` entity:
- Define `$_accessible` with all fields accessible except `id`
- Fields: name, description, is_active, deleted_at, created, modified
- Mark association fields accessible: roles, users, _joinData

Create `UsersRole` entity (pivot):
- Define `$_accessible` with user_id, role_id, created, modified
- Mark association fields accessible: user, role

Create `UsersPermission` entity (pivot):
- Define `$_accessible` with user_id, permission_id, created, modified
- Mark association fields accessible: user, permission

Create `RolesPermission` entity (pivot):
- Define `$_accessible` with role_id, permission_id, created, modified
- Mark association fields accessible: role, permission

Add PHPDoc @property annotations for all fields and associations.
  </action>
  <verify>
All five Entity classes exist with correct namespace. Each has `$_accessible` array. PHPDoc @property annotations document fields and associations.
  </verify>
  <done>
Five Entity classes with accessible fields configured, association fields marked accessible for ORM operations.
  </done>
</task>

</tasks>

<verification>
1. All Table classes in `src/Model/Table/` with correct namespace `Rbac\Model\Table`
2. All Entity classes in `src/Model/Entity/` with correct namespace `Rbac\Model\Entity`
3. Primary tables (Roles, Permissions) have belongsToMany with explicit `through` option
4. Pivot tables have belongsTo to both related tables
5. All tables have Timestamp behavior
6. Validation rules enforce unique names on Roles and Permissions
7. Permission name validation includes regex pattern for dotted format
8. All public methods have PHPDoc documentation
</verification>

<success_criteria>
- 5 Table classes with configured associations
- 5 Entity classes with accessible fields
- RolesTable can eager-load users and permissions via `contain(['Users', 'Permissions'])`
- PermissionsTable can eager-load roles and direct users
- All associations use explicit `through` option for pivot tables
- Validation prevents duplicate role/permission names
- Permission name validated against `[a-zA-Z0-9.]+` pattern
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-02-SUMMARY.md`
</output>
