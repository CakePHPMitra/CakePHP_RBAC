---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/Migrations/20260205000001_CreateRolesTable.php
  - config/Migrations/20260205000002_CreatePermissionsTable.php
  - config/Migrations/20260205000003_CreateUsersRolesTable.php
  - config/Migrations/20260205000004_CreateUsersPermissionsTable.php
  - config/Migrations/20260205000005_CreateRolesPermissionsTable.php
autonomous: true

must_haves:
  truths:
    - "Roles table exists with all required columns"
    - "Permissions table exists with all required columns"
    - "All three pivot tables exist with composite primary keys"
    - "All migrations are reversible (rollback works)"
    - "Composite unique indexes exist on all pivot tables"
  artifacts:
    - path: "config/Migrations/20260205000001_CreateRolesTable.php"
      provides: "Roles table migration"
      contains: "class CreateRolesTable extends BaseMigration"
    - path: "config/Migrations/20260205000002_CreatePermissionsTable.php"
      provides: "Permissions table migration"
      contains: "class CreatePermissionsTable extends BaseMigration"
    - path: "config/Migrations/20260205000003_CreateUsersRolesTable.php"
      provides: "UsersRoles pivot table migration"
      contains: "class CreateUsersRolesTable extends BaseMigration"
    - path: "config/Migrations/20260205000004_CreateUsersPermissionsTable.php"
      provides: "UsersPermissions pivot table migration"
      contains: "class CreateUsersPermissionsTable extends BaseMigration"
    - path: "config/Migrations/20260205000005_CreateRolesPermissionsTable.php"
      provides: "RolesPermissions pivot table migration"
      contains: "class CreateRolesPermissionsTable extends BaseMigration"
  key_links:
    - from: "users_roles"
      to: "users (UUID)"
      via: "foreign key user_id"
      pattern: "addForeignKey.*user_id.*users"
    - from: "users_roles"
      to: "roles (integer)"
      via: "foreign key role_id"
      pattern: "addForeignKey.*role_id.*roles"
---

<objective>
Create reversible database migrations for all RBAC tables: roles, permissions, users_roles, users_permissions, and roles_permissions.

Purpose: Establish the database foundation that all subsequent phases query. Tables must have correct column types, constraints, and indexes for performance.

Output: Five migration files in `config/Migrations/` that can be run with `bin/cake migrations migrate --plugin Rbac` and rolled back cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-database-foundation/01-CONTEXT.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roles and permissions table migrations</name>
  <files>
    config/Migrations/20260205000001_CreateRolesTable.php
    config/Migrations/20260205000002_CreatePermissionsTable.php
  </files>
  <action>
Create migration for `roles` table with columns:
- `id` (integer, auto-increment primary key - default)
- `name` (string 255, not null, unique index)
- `description` (text, nullable)
- `is_system` (boolean, default false, not null) - protects system roles from deletion
- `is_default` (boolean, default false, not null) - auto-assigned to new users
- `is_active` (boolean, default true, not null)
- `sort_order` (integer, default 0, not null) - display order
- `parent_id` (integer, nullable) - future hierarchical roles
- `deleted_at` (datetime, nullable) - soft delete support
- `created` (datetime, not null)
- `modified` (datetime, not null)

Add indexes:
- Unique on `name`
- Index on `is_active`
- Index on `sort_order`

Create migration for `permissions` table with columns:
- `id` (integer, auto-increment primary key)
- `name` (string 255, not null, unique index) - dotted format: resource.action
- `description` (text, nullable)
- `is_active` (boolean, default true, not null)
- `deleted_at` (datetime, nullable) - soft delete support
- `created` (datetime, not null)
- `modified` (datetime, not null)

Add indexes:
- Unique on `name`
- Index on `is_active`

Use `change()` method for reversible migrations. Follow CakePHP 5 Migrations patterns from RESEARCH.md.
  </action>
  <verify>
Files exist at correct paths with proper class names extending BaseMigration. Each migration uses change() method.
  </verify>
  <done>
Roles migration defines all columns per CONTEXT.md decisions (is_system, is_default, sort_order, parent_id, deleted_at).
Permissions migration defines name (unique), description, is_active, deleted_at, timestamps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pivot table migrations with foreign keys</name>
  <files>
    config/Migrations/20260205000003_CreateUsersRolesTable.php
    config/Migrations/20260205000004_CreateUsersPermissionsTable.php
    config/Migrations/20260205000005_CreateRolesPermissionsTable.php
  </files>
  <action>
Create three pivot table migrations following the pattern from RESEARCH.md.

**users_roles** pivot table:
- Use composite primary key: `['user_id', 'role_id']` (no separate id column)
- `user_id` (uuid, not null) - matches CakeDC/Users UUID format
- `role_id` (integer, not null)
- `created` (datetime, not null)
- `modified` (datetime, not null)
- Composite unique index on `['user_id', 'role_id']`
- Index on `role_id` for reverse lookups
- Foreign key `user_id` -> `users.id` with CASCADE delete, CASCADE update
- Foreign key `role_id` -> `roles.id` with RESTRICT delete, CASCADE update

**users_permissions** pivot table (direct user permissions):
- Use composite primary key: `['user_id', 'permission_id']`
- `user_id` (uuid, not null)
- `permission_id` (integer, not null)
- `created` (datetime, not null)
- `modified` (datetime, not null)
- Composite unique index on `['user_id', 'permission_id']`
- Index on `permission_id` for reverse lookups
- Foreign key `user_id` -> `users.id` with CASCADE delete, CASCADE update
- Foreign key `permission_id` -> `permissions.id` with RESTRICT delete, CASCADE update

**roles_permissions** pivot table:
- Use composite primary key: `['role_id', 'permission_id']`
- `role_id` (integer, not null)
- `permission_id` (integer, not null)
- `created` (datetime, not null)
- `modified` (datetime, not null)
- Composite unique index on `['role_id', 'permission_id']`
- Index on `permission_id` for reverse lookups
- Foreign key `role_id` -> `roles.id` with CASCADE delete, CASCADE update
- Foreign key `permission_id` -> `permissions.id` with CASCADE delete, CASCADE update

Critical: Use `'id' => false` and `'primary_key' => [...]` pattern for composite primary keys.
  </action>
  <verify>
All three migration files exist. Each uses composite primary key pattern. Foreign key delete rules match CONTEXT.md decisions:
- User deletion: CASCADE to users_roles and users_permissions
- Role deletion: RESTRICT if users assigned, CASCADE to roles_permissions
- Permission deletion: RESTRICT if users assigned directly, CASCADE to roles_permissions
  </verify>
  <done>
Three pivot tables with composite primary keys, composite unique indexes, correct foreign key constraints, and timestamps.
  </done>
</task>

</tasks>

<verification>
1. All 5 migration files exist in config/Migrations/ with sequential timestamps
2. Each migration class extends BaseMigration and uses change() method
3. Primary tables (roles, permissions) have unique name indexes
4. Pivot tables use composite primary keys (no separate id column)
5. All pivot tables have composite unique indexes
6. Foreign key constraints match CONTEXT.md decisions
7. Soft delete columns (deleted_at) present on roles and permissions tables
</verification>

<success_criteria>
- 5 migration files created following CakePHP 5 Migrations patterns
- Roles table has is_system, is_default, sort_order, parent_id columns per CONTEXT.md
- All pivot tables use composite primary keys
- Composite unique indexes on all pivot tables for performance
- Foreign key constraints enforce referential integrity with correct CASCADE/RESTRICT rules
- Migrations are reversible (use change() method only)
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-01-SUMMARY.md`
</output>
