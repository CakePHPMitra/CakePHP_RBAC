---
phase: 01-database-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - config/Seeds/RolesSeed.php
  - config/Seeds/PermissionsSeed.php
  - config/Seeds/RolesPermissionsSeed.php
autonomous: true

must_haves:
  truths:
    - "Seed creates superadmin, admin, and user roles"
    - "Seed creates rbac.* permissions for admin management"
    - "Seed creates dashboard and profile permissions for basic users"
    - "Admin role has all rbac.* permissions assigned"
    - "User role has dashboard.view, profile.view, profile.edit assigned"
    - "Superadmin has NO permissions assigned (bypass in service layer)"
    - "Seeds are idempotent - safe to run multiple times"
  artifacts:
    - path: "config/Seeds/RolesSeed.php"
      provides: "Default roles seed data"
      contains: "class RolesSeed extends BaseSeed"
    - path: "config/Seeds/PermissionsSeed.php"
      provides: "RBAC and basic permissions seed data"
      contains: "class PermissionsSeed extends BaseSeed"
    - path: "config/Seeds/RolesPermissionsSeed.php"
      provides: "Role-permission assignments seed data"
      contains: "getDependencies"
  key_links:
    - from: "RolesPermissionsSeed"
      to: "RolesSeed"
      via: "getDependencies()"
      pattern: "getDependencies.*RolesSeed"
    - from: "RolesPermissionsSeed"
      to: "PermissionsSeed"
      via: "getDependencies()"
      pattern: "getDependencies.*PermissionsSeed"
---

<objective>
Create idempotent seed files for default roles, permissions, and role-permission assignments.

Purpose: Provide initial data for the RBAC system that can be deployed reliably across environments. Seeds establish the superadmin, admin, and user roles with appropriate permissions.

Output: Three seed files in `config/Seeds/` that can be run with `bin/cake migrations seed --plugin Rbac` multiple times without errors or duplicates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-database-foundation/01-CONTEXT.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RolesSeed and PermissionsSeed</name>
  <files>
    config/Seeds/RolesSeed.php
    config/Seeds/PermissionsSeed.php
  </files>
  <action>
Create `RolesSeed` extending `Migrations\BaseSeed`:
- Implement idempotency check: query for 'superadmin' role, skip if exists
- Create three roles:
  1. **superadmin**: is_system=true, is_default=false, is_active=true, sort_order=1
     - description: "System administrator with unrestricted access"
  2. **admin**: is_system=false, is_default=false, is_active=true, sort_order=2
     - description: "RBAC administrator - manages roles and permissions"
  3. **user**: is_system=false, is_default=true, is_active=true, sort_order=3
     - description: "Standard user with basic access"
- Set parent_id=null for all
- Set created/modified to current timestamp

Create `PermissionsSeed` extending `Migrations\BaseSeed`:
- Implement idempotency check: query for 'rbac.roles.view' permission, skip if exists
- Create RBAC management permissions (for admin role):
  - `rbac.roles.view` - "View roles list"
  - `rbac.roles.create` - "Create new roles"
  - `rbac.roles.edit` - "Edit existing roles"
  - `rbac.roles.delete` - "Delete roles"
  - `rbac.permissions.view` - "View permissions list"
  - `rbac.permissions.create` - "Create permissions"
  - `rbac.permissions.edit` - "Edit permissions"
  - `rbac.permissions.delete` - "Delete permissions"
  - `rbac.users.assign` - "Assign roles and permissions to users"
  - `rbac.matrix.view` - "View permission matrix"
  - `rbac.matrix.edit` - "Edit permission matrix assignments"
- Create basic user permissions:
  - `dashboard.view` - "View dashboard"
  - `profile.view` - "View own profile"
  - `profile.edit` - "Edit own profile"
- All permissions: is_active=true, description as noted

Use `$this->getAdapter()->fetchRow()` for idempotency checks. Use `$this->table('tablename')->insert($data)->saveData()` for inserts.
  </action>
  <verify>
Both seed files exist. RolesSeed creates exactly 3 roles with correct is_system flags. PermissionsSeed creates 11 rbac.* permissions and 3 basic permissions.
  </verify>
  <done>
RolesSeed creates superadmin (is_system=true), admin, user (is_default=true) roles.
PermissionsSeed creates rbac.* namespace permissions for admin UI and basic user permissions.
Both seeds are idempotent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RolesPermissionsSeed with dependencies</name>
  <files>
    config/Seeds/RolesPermissionsSeed.php
  </files>
  <action>
Create `RolesPermissionsSeed` extending `Migrations\BaseSeed`:

Implement `getDependencies()` method returning:
```php
return ['RolesSeed', 'PermissionsSeed'];
```

Implement `run()` method:
1. Idempotency check: query `roles_permissions` table, skip if any records exist
2. Fetch role IDs:
   - Query for 'admin' role ID
   - Query for 'user' role ID
   - (Do NOT fetch superadmin - it gets no permissions)
3. Fetch permission IDs:
   - Query all permissions WHERE name LIKE 'rbac.%' (for admin)
   - Query permissions WHERE name IN ('dashboard.view', 'profile.view', 'profile.edit') (for user)
4. Build data array:
   - For admin role: assign ALL rbac.* permissions
   - For user role: assign dashboard.view, profile.view, profile.edit
5. Insert role_permission records with created/modified timestamps

Critical: Superadmin role must have ZERO permission assignments. The bypass is handled in the service layer (Phase 2).
  </action>
  <verify>
Seed file exists with getDependencies() returning both RolesSeed and PermissionsSeed. Idempotency check prevents duplicate inserts. Admin gets all rbac.* permissions. User gets exactly 3 permissions.
  </verify>
  <done>
RolesPermissionsSeed assigns permissions correctly:
- Admin role: all rbac.* permissions (11 total)
- User role: dashboard.view, profile.view, profile.edit (3 total)
- Superadmin: zero permissions (bypass handled elsewhere)
Seed uses getDependencies() for execution ordering.
  </done>
</task>

</tasks>

<verification>
1. All three seed files exist in config/Seeds/
2. RolesSeed creates exactly 3 roles with correct attributes
3. PermissionsSeed creates 14 permissions (11 rbac.* + 3 basic)
4. RolesPermissionsSeed uses getDependencies() for ordering
5. All seeds implement idempotency (check before insert)
6. Superadmin has is_system=true, user has is_default=true
7. Superadmin has zero permission assignments
8. Admin has all rbac.* permissions
9. User has dashboard.view, profile.view, profile.edit
</verification>

<success_criteria>
- 3 seed files created following CakePHP Migrations seeding patterns
- Seeds idempotent: running `bin/cake migrations seed --plugin Rbac` multiple times is safe
- Role assignments correct:
  - Superadmin: system role, no permissions (bypass)
  - Admin: all RBAC management permissions
  - User: default role, basic dashboard/profile permissions
- Dependency ordering ensures roles and permissions exist before assignments
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-03-SUMMARY.md`
</output>
