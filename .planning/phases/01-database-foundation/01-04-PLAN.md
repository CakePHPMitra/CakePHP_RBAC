---
phase: 01-database-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - tests/Fixture/RolesFixture.php
  - tests/Fixture/PermissionsFixture.php
  - tests/Fixture/UsersRolesFixture.php
  - tests/Fixture/UsersPermissionsFixture.php
  - tests/Fixture/RolesPermissionsFixture.php
  - tests/TestCase/Model/Table/RolesTableTest.php
  - tests/TestCase/Model/Table/PermissionsTableTest.php
  - tests/TestCase/Model/Table/UsersRolesTableTest.php
  - phpunit.xml
autonomous: true

must_haves:
  truths:
    - "Unit tests can load fixtures and run queries"
    - "RolesTable associations load permissions correctly"
    - "PermissionsTable associations load roles correctly"
    - "Pivot table associations enable eager loading"
    - "Unique constraints are enforced via validation"
    - "Tests pass with vendor/bin/phpunit"
  artifacts:
    - path: "tests/Fixture/RolesFixture.php"
      provides: "Test data for roles"
      contains: "class RolesFixture extends TestFixture"
    - path: "tests/TestCase/Model/Table/RolesTableTest.php"
      provides: "Unit tests for RolesTable"
      contains: "testBelongsToManyPermissions"
      min_lines: 50
    - path: "tests/TestCase/Model/Table/PermissionsTableTest.php"
      provides: "Unit tests for PermissionsTable"
      contains: "testBelongsToManyRoles"
    - path: "phpunit.xml"
      provides: "PHPUnit configuration for plugin"
      contains: "bootstrap"
  key_links:
    - from: "RolesTableTest"
      to: "RolesTable"
      via: "getTableLocator()->get('Rbac.Roles')"
      pattern: "getTableLocator.*Rbac\\.Roles"
    - from: "Tests"
      to: "Fixtures"
      via: "$fixtures array"
      pattern: "fixtures.*plugin\\.Rbac"
---

<objective>
Create test fixtures and unit tests for RBAC model layer validating associations, constraints, and basic CRUD operations.

Purpose: Ensure the database foundation is correctly implemented. Tests verify that associations load correctly, unique constraints are enforced, and the model layer is ready for service layer integration.

Output: Five fixture files and three Table test classes that pass with `vendor/bin/phpunit`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-database-foundation/01-CONTEXT.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test fixtures</name>
  <files>
    tests/Fixture/RolesFixture.php
    tests/Fixture/PermissionsFixture.php
    tests/Fixture/UsersRolesFixture.php
    tests/Fixture/UsersPermissionsFixture.php
    tests/Fixture/RolesPermissionsFixture.php
  </files>
  <action>
Create `RolesFixture` extending `Cake\TestSuite\Fixture\TestFixture`:
- Set `$table = 'roles'`
- Define sample records (at least 3):
  1. id=1, name='superadmin', is_system=true, is_default=false, is_active=true, sort_order=1
  2. id=2, name='admin', is_system=false, is_default=false, is_active=true, sort_order=2
  3. id=3, name='user', is_system=false, is_default=true, is_active=true, sort_order=3
- Include all columns: description, parent_id, deleted_at, created, modified

Create `PermissionsFixture`:
- Set `$table = 'permissions'`
- Define sample records (at least 5):
  1. id=1, name='rbac.roles.view', is_active=true
  2. id=2, name='rbac.roles.edit', is_active=true
  3. id=3, name='dashboard.view', is_active=true
  4. id=4, name='profile.view', is_active=true
  5. id=5, name='profile.edit', is_active=true

Create `UsersRolesFixture`:
- Set `$table = 'users_roles'`
- Use placeholder UUIDs for user_id (tests may mock or use CakeDC/Users fixtures)
- Sample: user_id='550e8400-e29b-41d4-a716-446655440001', role_id=2

Create `UsersPermissionsFixture`:
- Set `$table = 'users_permissions'`
- Sample direct permission assignment

Create `RolesPermissionsFixture`:
- Set `$table = 'roles_permissions'`
- Define assignments:
  - role_id=2 (admin) -> permission_id=1,2 (rbac permissions)
  - role_id=3 (user) -> permission_id=3,4,5 (basic permissions)
  - role_id=1 (superadmin) -> NO permissions

All fixtures include created/modified timestamps.
  </action>
  <verify>
All 5 fixture files exist in tests/Fixture/. Each fixture has $table property set correctly and $records array with sample data.
  </verify>
  <done>
Five fixtures with test data:
- Roles: superadmin, admin, user
- Permissions: rbac.* and basic permissions
- Pivot tables: sample assignments
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for Table classes</name>
  <files>
    tests/TestCase/Model/Table/RolesTableTest.php
    tests/TestCase/Model/Table/PermissionsTableTest.php
    tests/TestCase/Model/Table/UsersRolesTableTest.php
    phpunit.xml
  </files>
  <action>
Create `phpunit.xml` in plugin root if not exists:
- Configure bootstrap to `tests/bootstrap.php`
- Set testsuites for Model tests
- Configure colors and process isolation as needed

Create `RolesTableTest` extending `Cake\TestSuite\TestCase`:
- Set `$fixtures` array referencing all plugin fixtures:
  - 'plugin.Rbac.Roles'
  - 'plugin.Rbac.Permissions'
  - 'plugin.Rbac.RolesPermissions'
- Test methods:
  1. `testInitialize()` - Verify table name, display field, primary key
  2. `testBelongsToManyPermissions()` - Load role with `contain(['Permissions'])`, assert permissions loaded
  3. `testValidationRequiresName()` - Create entity without name, assert validation errors
  4. `testValidationUniqueNameConstraint()` - Create entity with duplicate name, assert fails
  5. `testFindActive()` - Test custom finder for is_active=true (if implemented)
  6. `testSystemRoleFlagSet()` - Verify superadmin has is_system=true

Create `PermissionsTableTest`:
- Set `$fixtures` array
- Test methods:
  1. `testInitialize()` - Verify table name, display field
  2. `testBelongsToManyRoles()` - Load permission with `contain(['Roles'])`, assert roles loaded
  3. `testValidationRequiresName()` - Validate name required
  4. `testValidationNameFormat()` - Test that name matches dotted format regex
  5. `testValidationUniqueNameConstraint()` - Duplicate name fails

Create `UsersRolesTableTest`:
- Minimal test verifying:
  1. `testInitialize()` - Verify belongsTo associations exist
  2. `testBelongsToRoles()` - Load with contain(['Roles']), verify association

Use `$this->getTableLocator()->get('Rbac.Roles')` pattern for getting tables.
  </action>
  <verify>
Run `vendor/bin/phpunit` from plugin directory. All tests should pass. Tests cover association loading, validation rules, and unique constraints.
  </verify>
  <done>
Three test classes with comprehensive tests for:
- Table initialization and configuration
- belongsToMany associations with eager loading
- Validation rules (required, unique, format)
phpunit.xml configured for plugin testing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test bootstrap and verify test suite</name>
  <files>
    tests/bootstrap.php
  </files>
  <action>
Create `tests/bootstrap.php` if not exists:
- Load Composer autoloader
- Define plugin paths
- Configure CakePHP for testing:
  - Set APP_NAME
  - Configure Cache (disable or use array engine)
  - Configure test database connection
  - Load plugin via Application

The bootstrap should allow running tests standalone:
```php
require dirname(__DIR__) . '/vendor/autoload.php';

use Cake\Core\Configure;
use Cake\Datasource\ConnectionManager;

// Configure test database (SQLite in memory for speed)
ConnectionManager::setConfig('test', [
    'className' => 'Cake\Database\Connection',
    'driver' => 'Cake\Database\Driver\Sqlite',
    'database' => ':memory:',
]);

// Load plugin tables
```

Note: If the plugin is meant to be installed in a host app, tests may need to run in host app context. Create minimal bootstrap that works standalone.
  </action>
  <verify>
Run `vendor/bin/phpunit --list-tests` to verify test discovery. Run `vendor/bin/phpunit` to execute all tests.
  </verify>
  <done>
Test bootstrap configured. Running `vendor/bin/phpunit` from plugin root discovers and executes tests. All tests pass (or clearly indicate what's needed for host app integration).
  </done>
</task>

</tasks>

<verification>
1. All 5 fixture files exist in tests/Fixture/
2. Test classes exist in tests/TestCase/Model/Table/
3. phpunit.xml configured for plugin
4. tests/bootstrap.php enables standalone testing
5. `vendor/bin/phpunit --list-tests` shows all test methods
6. Tests verify:
   - Association eager loading works
   - Validation rules enforce unique names
   - Permission name format validated
   - System role flags set correctly
</verification>

<success_criteria>
- 5 fixture files with sample RBAC data
- 3 Table test classes covering associations and validation
- phpunit.xml configured for plugin testing
- `vendor/bin/phpunit` passes all tests (or documents integration requirements)
- Tests validate:
  - RolesTable loads permissions via contain()
  - PermissionsTable loads roles via contain()
  - Unique name constraints enforced
  - Permission name format validated
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-04-SUMMARY.md`
</output>
